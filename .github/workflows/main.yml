name: ğŸš€ CI/CD con SonarQube y Docker

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-analyze-deploy:
    name: ğŸ” Build + AnÃ¡lisis + Despliegue
    runs-on: self-hosted

    steps:
      - name: ğŸ“¥ Paso 1 - Clonar repositorio
        uses: actions/checkout@v4
        with:
          # SonarQube necesita el historial completo para analizar cÃ³digo nuevo
          fetch-depth: 0

      - name: â˜• Paso 2 - Configurar Java (usarÃ¡ el Maven del runner)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ“Š Paso 3 - Compilar y Analizar con SonarQube
        env:
          # El token de GitHub es Ãºtil para decorar Pull Requests
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Tu token de SonarQube, que hemos guardado de forma segura
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "ğŸ“¦ Compilando y ejecutando anÃ¡lisis SonarQube..."
          mvn verify sonar:sonar \
            -Dsonar.projectKey=lpapp \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ env.SONAR_TOKEN }}
          echo "âœ… AnÃ¡lisis completado."

      - name: ğŸ³ Paso 4 - Desplegar con Docker Compose
        run: |
          echo "ğŸ§¹ Apagando contenedores anteriores si existen..."
          docker compose -f docker/docker-compose.yml down -v --remove-orphans

          echo "ğŸš€ Iniciando nuevo despliegue..."
          docker compose -f docker/docker-compose.yml up -d --build

          echo "â³ Esperando 15 segundos para que la aplicaciÃ³n arranque..."
          sleep 15

          echo "ğŸ“‹ Contenedores activos:"
          docker ps

          echo "ğŸ“ Logs recientes del contenedor de la aplicaciÃ³n:"
          # AsegÃºrate de que el nombre del contenedor sea el correcto
          docker logs --tail=100 product_app || echo "âš ï¸ No se pudo obtener logs de 'product_app'"
